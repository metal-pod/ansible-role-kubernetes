---
- name: Fetch kubelet config for node to join the cluster
  # kubeadm join command does not work on BGP based networks. We therefore need to shadow the network with a docker container as a workaround.
  # This should be resolved after this was merged: https://github.com/kubernetes/kubernetes/pull/69578/
  # Needs to be killed, as it also tries for the kubelet to start; cannot be untangled (fetch & start happens both in kubelet-start phase)
  # TODO: still somehow nneds to be executes manually ... maybe omit timeout here, and implement a separate task afterwards to watch for /etc/kubernetes/kubelet.conf being created, then killing the container ?!
  # See also: https://github.com/moby/moby/issues/1905
  command: docker run -it --rm -d --name kubeadm_join_fetch -v /etc/kubernetes/admin.conf:/kubeconfig -v /var/lib/kubelet:/var/lib/kubelet -v /etc/kubernetes:/etc/kubernetes wise2c/kubeadm-version:v{{ kubernetes_version }} {{ kubernetes_join_command }} --skip-phases=preflight,control-plane-join
  args:
    creates: /etc/kubernetes/kubelet.conf
  failed_when: false
  tags: ['skip_ansible_lint']
  register: kubernetes_join_fetch_cmd_result

- name: Wait few seconds for docker container to fetch kubelet config
  command: sleep 5
  when: kubernetes_join_fetch_cmd_result is changed

- name: Stop kubeadm_join_fetch container
  command: docker stop kubeadm_join_fetch
  failed_when: false
  when: kubernetes_join_fetch_cmd_result is changed

- name: Remove kubeadm_join_fetch container
  command: docker rm kubeadm_join_fetch
  failed_when: false
  when: kubernetes_join_fetch_cmd_result is changed

- name: Join node to Kubernetes master
  command: "{{ kubernetes_join_command }} --skip-phases=preflight,kubelet-start"
  when: kubernetes_join_fetch_cmd_result is changed
  tags: ['skip_ansible_lint']
  register: kubernetes_join_command_result
